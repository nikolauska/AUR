pkgname=github-copilot-cli
_pkgexec=copilot

pkgver=0.0.394
pkgrel=1

pkgdesc="GitHub Copilot CLI brings the power of Copilot coding agent directly to your terminal."

url="https://github.com/github/copilot-cli"
_urlraw="https://raw.githubusercontent.com/github/copilot-cli/v${pkgver}"

conflicts=("github-copilot-cli" "github-copilot-cli-legacy")
depends=("glibc" "gcc-libs" "nodejs" "glib2" "libsecret")
conflicts=("github-copilot-cli")
makedepends=("npm" "jq")
provides=("${_pkgexec}")

arch=("x86_64")
options=(!strip emptydirs staticlibs zipman)

license=("LicenseRef-GitHub")

source=("https://registry.npmjs.org/@github/copilot/-/copilot-${pkgver}.tgz")
noextract=("copilot-${pkgver}.tgz")

sha1sums=("8ff1b3478969b363e46a9a5b229cbb1353afc6c7")

# Document: https://wiki.archlinux.org/title/Node.js_package_guidelines
package() {
  msg2 "Install using Using NPM"
  npm install -s -g \
    --cache "${srcdir}/npm-cache" \
    --prefix "${pkgdir}/usr" \
    "${srcdir}/copilot-${pkgver}.tgz"

  msg2 "Fix ownership of ALL FILES"
  find "${pkgdir}/usr" -type d -exec chmod 755 {} +
  chown -R root:root "${pkgdir}"

  msg2 "Remove references to PKGDIR"
  find "${pkgdir}" -name package.json -print0 | xargs -r -0 sed -i '/_where/d'

  msg2 "Fixing 'package.json'"
  local tmppackage="$(mktemp)"
  local pkgjson="${pkgdir}/usr/lib/node_modules/@github/copilot/package.json"
  jq '.|=with_entries(select(.key|test("_.+")|not))' "${pkgjson}" >"${tmppackage}"
  mv "${tmppackage}" "${pkgjson}"
  chmod 644 "${pkgjson}"

  msg2 "More fixes for 'package.json'"
  find "${pkgdir}" -type f -name package.json | while read pkgjson; do
    local tmppackage="$(mktemp)"
    jq 'del(.man)' "${pkgjson}" >"${tmppackage}"
    mv "${tmppackage}" "${pkgjson}"
    chmod 644 "${pkgjson}"
  done
}
